services:
  # Database Service
  postgres:
    image: postgres:15-alpine
    container_name: leanwms_db
    restart: always
    environment:
      POSTGRES_USER: leanwms
      POSTGRES_PASSWORD: leanwms
      POSTGRES_DB: leanwms
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - leanwms_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U leanwms"]
      interval: 5s
      timeout: 5s
      retries: 5

  # Backend API Service
  api:
    container_name: leanwms_api
    build:
      context: .
      dockerfile: apps/api/Dockerfile
      target: dev
    restart: on-failure
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DATABASE_URL: postgresql://leanwms:leanwms@postgres:5432/leanwms
      JWT_SECRET: ${JWT_SECRET:-changeme_in_production}
      JWT_REFRESH_SECRET: ${JWT_REFRESH_SECRET:-changeme_in_production}
      API_PORT: 3000
      CORS_ORIGINS: http://localhost:80,http://localhost:3000,http://localhost:5173
      RUST_LOG: info,lean_wms_api=debug
    ports:
      - '3000:3000'
    volumes:
      - .:/app
      - /app/target
    command: cargo watch -x "run -p lean-wms-api"
    networks:
      - leanwms_network

  # Frontend Web Service
  web:
    container_name: leanwms_web
    build:
      context: .
      dockerfile: apps/client-web/Dockerfile
    restart: always
    ports:
      - '80:80'
    networks:
      - leanwms_network

networks:
  leanwms_network:
    driver: bridge

volumes:
  postgres_data:
